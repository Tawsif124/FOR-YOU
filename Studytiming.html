<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time for Study - Interactive Learning Hub</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Tone.js for ambient sounds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Light blue background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }

        /* Main container styling */
        .app-container {
            background: linear-gradient(135deg, #ffffff, #f0faff);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 30px;
            text-align: center;
            max-width: 900px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px; /* Space for footer */
        }

        @media (min-width: 768px) {
            .app-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Section titles */
        h1, h2 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 15px;
        }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.8rem; border-bottom: 2px solid #a7d9f7; padding-bottom: 8px;}

        /* Buttons general style */
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Specific button colors */
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-info { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; } /* Purple for Idea/Prompt */

        /* Timer section */
        .timer-display {
            font-size: 4rem;
            font-weight: 800;
            color: #34495e;
            margin-bottom: 20px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .timer-controls, .sound-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Gamification */
        .gamification-section, .tree-garden-section, .doodle-zone-section, .mindfulness-section, .llm-section {
            background-color: #f8faff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }

        .avatar-display {
            font-size: 5rem;
            margin-bottom: 10px;
            line-height: 1; /* Adjust line height for emoji */
        }
        .pet-display {
             font-size: 4rem;
             margin-top: 10px;
             animation: bounce 2s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Knowledge Tree */
        .tree-container {
            width: 100%;
            height: 150px;
            background-color: #e6ffe6;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .tree {
            position: absolute;
            bottom: 0;
            width: 50px; /* Base size */
            height: 50px;
            background-color: #8B4513; /* Brown trunk */
            border-radius: 50%; /* For trunk shape, will be overridden by branches */
            transition: all 0.5s ease-out;
            transform-origin: bottom;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            font-size: 0; /* Hide initial text */
        }
        .tree-leaves {
            position: absolute;
            bottom: 40px; /* Above trunk */
            width: 100px;
            height: 100px;
            background-color: #228B22; /* Forest green leaves */
            border-radius: 50%;
            transition: all 0.5s ease-out;
            opacity: 0; /* Hidden initially */
        }
        /* Dynamic tree growth stages */
        .tree-stage-0 .tree { transform: scaleY(0.5); height: 25px; }
        .tree-stage-1 .tree { transform: scaleY(1); height: 50px; }
        .tree-stage-1 .tree-leaves { opacity: 1; transform: scale(0.5); }
        .tree-stage-2 .tree { height: 70px; }
        .tree-stage-2 .tree-leaves { transform: scale(0.7); }
        .tree-stage-3 .tree { height: 90px; }
        .tree-stage-3 .tree-leaves { transform: scale(0.9); }
        .tree-stage-4 .tree { height: 110px; }
        .tree-stage-4 .tree-leaves { transform: scale(1.1); }
        .tree-stage-5 .tree { height: 130px; }
        .tree-stage-5 .tree-leaves { transform: scale(1.3); }

        /* Doodle Zone */
        #doodleCanvas {
            border: 2px solid #ccc;
            border-radius: 10px;
            background-color: white;
            cursor: crosshair;
            touch-action: none; /* Prevent scrolling/zooming on canvas touch */
        }

        /* Mindfulness Break */
        .mindfulness-content {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #555;
            text-align: center;
            margin-top: 15px;
        }

        /* LLM Prompt/Quote */
        .llm-output-area {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            min-height: 100px;
            text-align: left;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            margin-top: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles (Re-used/adapted from previous code) */
        .llm-modal-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .llm-modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 700px;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .llm-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .llm-modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }
        .llm-modal-close-btn {
            color: #aaa;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .llm-modal-close-btn:hover,
        .llm-modal-close-btn:focus {
            color: #000;
            text-decoration: none;
        }
        .llm-modal-body {
            flex-grow: 1;
            color: #555;
            font-size: 16px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .llm-modal-body textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
        }
        .llm-modal-body .generate-btn {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background 0.3s ease, transform 0.2s ease;
            user-select: none;
        }
        .llm-modal-body .generate-btn:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: scale(1.03);
        }
        .llm-modal-body .generate-btn:active {
            transform: scale(0.95);
        }
        .llm-response-area {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            min-height: 50px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
        }
        /* Mobile Responsiveness */
        @media (max-width: 640px) {
            .app-container {
                padding: 15px;
                gap: 15px;
            }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            .timer-display { font-size: 3rem; }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            .timer-controls, .sound-controls {
                flex-direction: column;
                gap: 10px;
            }
            .avatar-display, .pet-display { font-size: 4rem; }
            #doodleCanvas {
                width: 100%;
                height: 200px; /* Smaller canvas on mobile */
            }
            .llm-modal-content {
                width: 95%;
                padding: 20px;
            }
            .llm-modal-header h2 { font-size: 20px; }
            .llm-modal-close-btn { font-size: 30px; }
            .llm-modal-body { font-size: 14px; }
            .llm-modal-body textarea { min-height: 80px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 1. Interactive Focus Mode (Pomodoro Timer & Ambient Sounds & Virtual Pet) -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìñ ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶Æ‡ßã‡¶° (‡¶™‡ßã‡¶Æ‡ßã‡¶°‡ßã‡¶∞‡ßã)</h2>
            <div class="timer-display" id="timerDisplay">25:00</div>
            <div class="flex items-center justify-center mt-4">
                <span id="virtualPet" class="pet-display">üêæ</span>
            </div>
            <div class="timer-controls mt-6">
                <button class="btn btn-primary" id="startButton">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-secondary" id="pauseButton">‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®</button>
                <button class="btn btn-danger" id="resetButton">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
            </div>
            <div class="sound-controls mt-4">
                <button class="btn btn-info" id="rainSoundBtn">‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø üåßÔ∏è</button>
                <button class="btn btn-info" id="forestSoundBtn">‡¶¨‡¶® üå≥</button>
                <button class="btn btn-info" id="cafeSoundBtn">‡¶ï‡ßç‡¶Ø‡¶æ‡¶´‡ßá ‚òï</button>
                <button class="btn btn-info" id="oceanSoundBtn">‡¶∏‡¶æ‡¶ó‡¶∞ üåä</button>
                <button class="btn btn-danger" id="stopSoundBtn">‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Ö‡¶´ üîá</button>
            </div>
        </section>

        <!-- 2. Study Adventure Gamification & Progress Tracker -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üöÄ ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶≠‡ßá‡¶û‡ßç‡¶ö‡¶æ‡¶∞</h2>
            <div class="avatar-display" id="userAvatar">üßë‚Äçüéì</div>
            <p class="text-lg font-semibold mt-2">‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü: <span id="studyPoints" class="text-blue-600">0</span></p>
            <p class="text-lg font-semibold">‡¶≤‡ßá‡¶≠‡ßá‡¶≤: <span id="studyLevel" class="text-green-600">1</span></p>
            <p class="text-md text-gray-600 mt-2" id="levelProgress">‡¶Ü‡¶∞‡¶ì 100 ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø!</p>
            <div class="mt-4 text-center">
                <h3 class="text-xl font-bold text-gray-700">‡¶Ü‡¶®‡¶≤‡¶ï‡¶° ‡¶è‡¶∞‡¶ø‡ßü‡¶æ:</h3>
                <p id="unlockedArea" class="text-md text-purple-600 italic">‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞</p>
            </div>
        </section>

        <!-- 3. Knowledge Tree / Idea Garden -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center col-span-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üå≥ ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶¨‡ßÉ‡¶ï‡ßç‡¶∑</h2>
            <p class="text-md text-gray-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶¨‡ßÉ‡¶ï‡ßç‡¶∑‡¶ï‡ßá ‡¶¨‡ßú ‡¶ï‡¶∞‡ßá ‡¶§‡ßÅ‡¶≤‡¶¨‡ßá!</p>
            <div class="tree-container mt-4">
                <div id="knowledgeTree" class="tree tree-stage-0">
                    <div class="tree-leaves"></div>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ó‡¶æ‡¶õ ‡¶è‡¶ñ‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ú <span id="treeStage">0</span> ‡¶è ‡¶Ü‡¶õ‡ßá‡•§</p>
        </section>

        <!-- 4. Mindfulness Breaks -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üßò ‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶´‡ßÅ‡¶≤‡¶®‡ßá‡¶∏ ‡¶¨‡ßç‡¶∞‡ßá‡¶ï</h2>
            <button class="btn btn-success" id="mindfulnessBtn">‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶´‡ßÅ‡¶≤‡¶®‡ßá‡¶∏ ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø üòå</button>
            <div class="mindfulness-content mt-4" id="mindfulnessContent">
                ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∞‡¶ø‡¶≤‡¶æ‡¶ï‡ßç‡¶∏‡¶ø‡¶Ç ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ ‡¶¨‡¶æ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶ö‡¶ø‡¶Ç ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§
            </div>
        </section>

        <!-- 5. Art Board / Doodle Zone -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üé® ‡¶Ü‡¶∞‡ßç‡¶ü ‡¶¨‡ßã‡¶∞‡ßç‡¶° / ‡¶°‡ßÅ‡¶°‡¶≤ ‡¶ú‡ßã‡¶®</h2>
            <canvas id="doodleCanvas" width="400" height="250" class="border border-gray-300 rounded-lg shadow-inner"></canvas>
            <div class="flex gap-4 mt-4">
                <button class="btn btn-danger" id="clearCanvasBtn">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® üóëÔ∏è</button>
                <input type="color" id="penColor" value="#3498db" class="p-1 rounded-md border border-gray-300 cursor-pointer">
                <input type="range" id="penWidth" min="1" max="10" value="3" class="w-24">
            </div>
        </section>

        <!-- 6. LLM-powered Quotes & Prompts (Integrated with Idea Generator Modal) -->
        <!-- The modal for LLM is assumed to be globally available as per previous context -->
        <section class="p-6 bg-white rounded-xl shadow-md flex flex-col items-center col-span-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üí° ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ</h2>
            <button class="btn btn-info" id="generatePromptBtn">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶°‡¶ø‡ßü‡¶æ/‡¶â‡¶ï‡ßç‡¶§‡¶ø ‡¶™‡¶æ‡¶®</button>
            <div class="llm-output-area mt-4" id="llmPromptOutput">
                ‡¶è‡¶ñ‡¶æ‡¶®‡ßá LLM ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶â‡¶ï‡ßç‡¶§‡¶ø ‡¶¨‡¶æ ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§
            </div>
        </section>
    </div>

    <!-- LLM Modal Structure (Re-used from main index.html) -->
    <div id="llmModal" class="llm-modal-overlay">
      <div class="llm-modal-content">
        <div class="llm-modal-header">
          <h2 id="llmModalTitle"></h2>
          <span class="llm-modal-close-btn" onclick="closeLLMModal()">&times;</span>
        </div>
        <div class="llm-modal-body" id="llmModalBody">
          <!-- Content loaded dynamically by JS -->
        </div>
      </div>
    </div>

    <script>
        // Global variables for Firebase (required by Canvas, though not used in this standalone file)
        const __app_id = '';
        const __firebase_config = '{}';
        const __initial_auth_token = '';

        // --- Global State Variables ---
        let timer;
        let timeLeft = 25 * 60; // 25 minutes in seconds (Pomodoro default)
        let isStudyMode = true; // true for study, false for break
        let isPaused = true;
        let studyPoints = 0;
        let studyLevel = 1;
        let completedSessions = 0; // For tree growth
        const studyDuration = 25 * 60; // 25 minutes
        const breakDuration = 5 * 60;  // 5 minutes
        const longBreakDuration = 15 * 60; // 15 minutes after every 4 pomodoros

        // Tone.js Synths for ambient sounds
        let ambientSound = null;
        const ambientSounds = {
            rain: new Tone.NoiseSynth({
                noise: { type: "white" },
                envelope: { attack: 0.1, decay: 1.0, sustain: 1.0, release: 1.0 }
            }).toDestination(),
            forest: new Tone.NoiseSynth({
                noise: { type: "brown" },
                envelope: { attack: 0.5, decay: 1.0, sustain: 1.0, release: 2.0 }
            }).toDestination(),
            cafe: new Tone.NoiseSynth({ // Simulating chatter
                noise: { type: "pink" },
                envelope: { attack: 0.2, decay: 0.8, sustain: 0.5, release: 0.8 }
            }).toDestination(),
            ocean: new Tone.NoiseSynth({ // Simulating waves
                noise: { type: "white" },
                envelope: { attack: 0.5, decay: 2.0, sustain: 0.8, release: 3.0 }
            }).toDestination(),
        };

        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        const virtualPet = document.getElementById('virtualPet');
        const studyPointsEl = document.getElementById('studyPoints');
        const studyLevelEl = document.getElementById('studyLevel');
        const levelProgressEl = document.getElementById('levelProgress');
        const unlockedAreaEl = document.getElementById('unlockedArea');
        const knowledgeTree = document.getElementById('knowledgeTree');
        const treeStageEl = document.getElementById('treeStage');
        const mindfulnessBtn = document.getElementById('mindfulnessBtn');
        const mindfulnessContent = document.getElementById('mindfulnessContent');
        const doodleCanvas = document.getElementById('doodleCanvas');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const penColorInput = document.getElementById('penColor');
        const penWidthInput = document.getElementById('penWidth');
        const generatePromptBtn = document.getElementById('generatePromptBtn');
        const llmPromptOutput = document.getElementById('llmPromptOutput');

        // --- Canvas Drawing Variables ---
        let ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let penColor = penColorInput.value;
        let penWidth = penWidthInput.value;

        // --- Pomodoro Timer Functions ---
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (!isPaused) return; // Already running or just started
            isPaused = false;
            virtualPet.textContent = 'üòä'; // Pet is happy when studying

            timer = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timer);
                    playAlarmSound(); // Notify end of session
                    if (isStudyMode) {
                        completedSessions++;
                        gainPoints(100); // Gain points for completing a study session
                        updatePetState('üéâ'); // Pet celebrates
                        updateTreeGrowth(); // Grow the tree
                        if (completedSessions % 4 === 0) {
                            timeLeft = longBreakDuration; // Long break
                            showLLMModal('‡¶≤‡¶Ç ‡¶¨‡ßç‡¶∞‡ßá‡¶ï! ‚òï', '<p style="text-align:center;">‡¶è‡¶ï‡¶ü‡¶ø ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø ‡¶®‡¶ø‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßá‡¶ï ‡¶≠‡¶æ‡¶≤‡ßã ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!</p>');
                        } else {
                            timeLeft = breakDuration; // Short break
                            showMindfulnessBreak(); // Show a mindfulness tip during break
                        }
                        isStudyMode = false;
                        alert('‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑! ‡¶è‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø ‡¶®‡¶ø‡¶®‡•§');
                    } else {
                        timeLeft = studyDuration; // Back to study
                        isStudyMode = true;
                        updatePetState('üòä'); // Pet is ready to study again
                        alert('‡¶¨‡¶ø‡¶∞‡¶§‡¶ø‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑! ‡¶è‡¶¨‡¶æ‡¶∞ ‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                    }
                    updateTimerDisplay();
                    isPaused = true; // Pause after switching modes, user must click start again
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timer);
            isPaused = true;
            virtualPet.textContent = 'üò¥'; // Pet is sleepy/resting
        }

        function resetTimer() {
            clearInterval(timer);
            isPaused = true;
            timeLeft = studyDuration;
            isStudyMode = true;
            updateTimerDisplay();
            virtualPet.textContent = 'üêæ'; // Pet resets
        }

        function playAlarmSound() {
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n");
            synth.triggerAttackRelease("E5", "8n", "+0.1");
            synth.triggerAttackRelease("G5", "8n", "+0.2");
        }

        // --- Gamification Functions ---
        function gainPoints(points) {
            studyPoints += points;
            studyPointsEl.textContent = studyPoints;
            checkLevelUp();
            updateLevelProgress();
        }

        function checkLevelUp() {
            // Simple leveling system: 100 points per level
            const newLevel = Math.floor(studyPoints / 100) + 1;
            if (newLevel > studyLevel) {
                studyLevel = newLevel;
                studyLevelEl.textContent = studyLevel;
                updatePetState('ü•≥'); // Pet celebrates level up
                alert(`‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ${studyLevel} ‡¶è ‡¶™‡ßå‡¶Å‡¶õ‡ßá‡¶õ‡ßá‡¶®!`);
                unlockNewArea(studyLevel); // Unlock new areas based on level
            }
        }

        function updateLevelProgress() {
            const pointsForNextLevel = (studyLevel * 100) - studyPoints;
            if (pointsForNextLevel <= 0) {
                 levelProgressEl.textContent = '‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá ‡¶Ø‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§!';
            } else {
                levelProgressEl.textContent = `‡¶Ü‡¶∞‡¶ì ${pointsForNextLevel} ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø!`;
            }
        }

        function updatePetState(emoji) {
            virtualPet.textContent = emoji;
        }

        function unlockNewArea(level) {
            let area = "‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞";
            if (level >= 2) area = "‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶´‡¶∞‡ßá‡¶∏‡ßç‡¶ü üå≤";
            if (level >= 3) area = "‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶∏‡¶æ‡¶ó‡¶∞ üåä";
            if (level >= 4) area = "‡¶¨‡ßç‡¶∞‡ßá‡¶®‡¶∏‡ßç‡¶ü‡¶∞‡ßç‡¶Æ ‡¶™‡¶æ‡¶π‡¶æ‡ßú ‚õ∞Ô∏è";
            if (level >= 5) area = "‡¶Ü‡¶á‡¶°‡¶ø‡ßü‡¶æ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶ï‡ßç‡¶∏‡¶ø üåå";
            unlockedAreaEl.textContent = area;
        }

        // --- Ambient Sound Functions ---
        function playAmbientSound(type) {
            if (ambientSound) {
                ambientSound.stop();
            }
            if (ambientSounds[type]) {
                ambientSound = ambientSounds[type];
                ambientSound.start();
                // Ensure it loops if applicable (Tone.NoiseSynth doesn't directly loop like Player, but continuous start is fine)
            }
        }

        function stopAllSounds() {
            if (ambientSound) {
                ambientSound.stop();
                ambientSound = null;
            }
        }

        // --- Knowledge Tree Functions ---
        function updateTreeGrowth() {
            const treeStage = Math.min(Math.floor(completedSessions / 2), 5); // 5 stages max, 2 sessions per stage
            knowledgeTree.className = `tree tree-stage-${treeStage}`;
            treeStageEl.textContent = treeStage;
        }

        // --- Mindfulness Break Functions ---
        const mindfulnessTips = [
            "‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶®‡¶ø‡¶®‡•§ ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶®‡¶ø‡¶®, ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶õ‡¶æ‡ßú‡ßÅ‡¶®‡•§",
            "‡¶ö‡ßã‡¶ñ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶ö‡ßÅ‡¶™‡¶ö‡¶æ‡¶™ ‡¶¨‡¶∏‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶ø‡¶®‡ßç‡¶§‡¶æ‡¶≠‡¶æ‡¶¨‡¶®‡¶æ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶¨‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§",
            "‡¶∂‡¶∞‡ßÄ‡¶∞‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßá ‡¶Æ‡¶®‡ßã‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®, ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§‡•§",
            "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶∞‡¶™‡¶æ‡¶∂‡ßá ‡ß´‡¶ü‡¶ø ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®, ‡ß™‡¶ü‡¶ø ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶≠‡¶¨ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡ß©‡¶ü‡¶ø ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®, ‡ß®‡¶ü‡¶ø ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶ó‡¶®‡ßç‡¶ß ‡¶®‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡ßß‡¶ü‡¶ø ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶∏‡ßç‡¶¨‡¶æ‡¶¶ ‡¶®‡¶ø‡¶®‡•§",
            "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∂‡¶æ‡¶®‡ßç‡¶§ ‡¶ó‡¶æ‡¶® ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶®‡ßã‡¶ü ‡¶â‡¶™‡¶≠‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
            "‡¶è‡¶ï ‡¶ó‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ú‡¶≤ ‡¶™‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßÅ‡¶Æ‡ßÅ‡¶ï ‡¶â‡¶™‡¶≠‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
            "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡ßá‡ßü‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶â‡¶†‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶ö‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ò‡¶æ‡ßú, ‡¶ï‡¶æ‡¶Å‡¶ß ‡¶è‡¶¨‡¶Ç ‡¶™‡¶ø‡¶†‡¶ï‡ßá ‡¶ü‡¶æ‡¶®‡ßÅ‡¶®‡•§",
            "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡ßç‡¶Æ‡ßÉ‡¶§‡¶ø ‡¶Æ‡¶®‡ßá ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
        ];

        function showMindfulnessBreak() {
            const randomIndex = Math.floor(Math.random() * mindfulnessTips.length);
            mindfulnessContent.textContent = mindfulnessTips[randomIndex];
            showLLMModal('‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶´‡ßÅ‡¶≤‡¶®‡ßá‡¶∏ ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø üòå', `<p>${mindfulnessTips[randomIndex]}</p>`);
        }

        // --- Doodle Zone Functions ---
        function initDoodleCanvas() {
            ctx = doodleCanvas.getContext('2d');
            ctx.strokeStyle = penColor;
            ctx.lineWidth = penWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            doodleCanvas.addEventListener('mousedown', startDrawing);
            doodleCanvas.addEventListener('mouseup', stopDrawing);
            doodleCanvas.addEventListener('mouseout', stopDrawing);
            doodleCanvas.addEventListener('mousemove', draw);

            // Touch events for mobile
            doodleCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling
                startDrawing(e.touches[0]);
            });
            doodleCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrawing();
            });
            doodleCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0]);
            });

            // Update pen color/width when input changes
            penColorInput.addEventListener('input', (e) => {
                penColor = e.target.value;
                ctx.strokeStyle = penColor;
            });
            penWidthInput.addEventListener('input', (e) => {
                penWidth = e.target.value;
                ctx.lineWidth = penWidth;
            });

            clearCanvasBtn.addEventListener('click', () => {
                ctx.clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX || e.clientX - doodleCanvas.offsetLeft, e.offsetY || e.clientY - doodleCanvas.offsetTop];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX || e.clientX - doodleCanvas.offsetLeft, e.offsetY || e.clientY - doodleCanvas.offsetTop);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX || e.clientX - doodleCanvas.offsetLeft, e.offsetY || e.clientY - doodleCanvas.offsetTop];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // --- LLM Integration Functions (Re-used/adapted from main index.html) ---
        async function callGeminiAPI(prompt) {
            const modalBody = document.getElementById('llmModalBody');
            const llmModalTitle = document.getElementById('llmModalTitle');

            // Save original content and title before showing loading
            const originalBodyContent = modalBody.innerHTML;
            const originalModalTitle = llmModalTitle.textContent;

            // Show loading spinner in modal
            modalBody.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center; color: #555;">‡¶Ü‡¶á‡¶°‡¶ø‡ßü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            llmModalTitle.textContent = '‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this in runtime

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return text;
                } else {
                    return "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
            } finally {
                // Restore original content/title or keep LLM response
                // This is handled by the caller of callGeminiAPI
            }
        }

        function showLLMModal(title, contentHTML) {
            const modal = document.getElementById('llmModal');
            const modalTitle = document.getElementById('llmModalTitle');
            const modalBody = document.getElementById('llmModalBody');

            modalTitle.textContent = title;
            modalBody.innerHTML = contentHTML;
            modal.style.display = 'flex';
        }

        function closeLLMModal() {
            document.getElementById('llmModal').style.display = 'none';
        }

        async function generateLLMPromptOrQuote() {
            const prompt = "Provide a concise, inspiring study quote or a quick brain-teaser/quiz prompt for students. Keep it engaging and short. (Example: 'What is the capital of France?')";
            llmPromptOutput.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center; color: #555;">‡¶Ü‡¶á‡¶°‡¶ø‡ßü‡¶æ/‡¶â‡¶ï‡ßç‡¶§‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            const generatedText = await callGeminiAPI(prompt);
            llmPromptOutput.innerHTML = `<div class="llm-response-area">${generatedText}</div>`;
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startTimer);
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);

        document.getElementById('rainSoundBtn').addEventListener('click', () => playAmbientSound('rain'));
        document.getElementById('forestSoundBtn').addEventListener('click', () => playAmbientSound('forest'));
        document.getElementById('cafeSoundBtn').addEventListener('click', () => playAmbientSound('cafe'));
        document.getElementById('oceanSoundBtn').addEventListener('click', () => playAmbientSound('ocean'));
        document.getElementById('stopSoundBtn').addEventListener('click', stopAllSounds);

        mindfulnessBtn.addEventListener('click', showMindfulnessBreak);
        generatePromptBtn.addEventListener('click', generateLLMPromptOrQuote);


        // Initial setup
        window.onload = function() {
            updateTimerDisplay();
            updateLevelProgress();
            updateTreeGrowth(); // Initialize tree
            initDoodleCanvas();
            generateLLMPromptOrQuote(); // Load initial quote/prompt
        }

    </script>
</body>
</html>
